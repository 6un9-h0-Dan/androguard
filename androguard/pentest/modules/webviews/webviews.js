// Ripped from https://github.com/Ch0pin/medusa/ and modified to fit Androguard packets

var webView = Java.use('android.webkit.WebView');
var webSettings = Java.use('android.webkit.WebSettings');

webSettings.setAllowContentAccess.implementation = function(allow){
    agPacket({allow: allow}).send();
    return this.setAllowContentAccess(allow);
}

webSettings.setAllowFileAccess.implementation = function(allow){
    agPacket({allow: allow}).send();
    return this.setAllowFileAccess(allow);

}
webSettings.setAllowFileAccessFromFileURLs.implementation = function(allow){
    agPacket({allow: allow}).send();
    return this.setAllowFileAccessFromFileURLs(allow);
}

webSettings.setAllowUniversalAccessFromFileURLs.implementation = function(allow){
    agPacket({allow: allow}).send();
    return this.setAllowUniversalAccessFromFileURLs(allow);

}
webSettings.setJavaScriptEnabled.implementation = function(allow){
    agPacket({allow: allow}).send();
    return this.setJavaScriptEnabled(allow);
}


webView.setVisibility.implementation = function(a){
    agPacket({a: a}).send();

    if(a == 2){
        console.log('Webview visibility set to Gone');
        //console.log('Cancelling ...' );
    }
    else if (a == 1){
        console.log('Webview visibility set to Hidden');
        //console.log('Cancelling....');
    }
        
    return this.setVisibility(a);
    
}
webView.addJavascriptInterface.implementation = function(object, name){
    agPacket({className: object.$className, name:name}).send();
    this.addJavascriptInterface(object,name);
}


webView.evaluateJavascript.implementation = function(script, resultCallback){
    agPacket({script: script}).send();
    this.evaluateJavascript(script, resultCallback);
}

webView.getOriginalUrl.implementation = function() {
    var ret =  this.getOriginalUrl();
    agPacket({ret: ret}).send();
    return ret;
}

function dumpWebview(wv){
    console.log('[i] -------- Dumping webview settings-----------:');
    highlight('     Allows Content Access: ',wv.getSettings().getAllowContentAccess());
    highlight('     Allows Javascript execution: ',wv.getSettings().getJavaScriptEnabled());
    highlight('     Allows File Access: ',wv.getSettings().getAllowFileAccess());
    highlight('     Allows File Access From URLs: ',wv.getSettings().getAllowFileAccessFromFileURLs());
    highlight('     Allows Universal Access from file URLs: ',wv.getSettings().getAllowUniversalAccessFromFileURLs());
    colorLog('[i] -------- Dumping webview settings EOF -------',{c:Color.Blue});

}

function highlight(tag, flag){
  if(flag)
    colorLog(tag + flag,{c:Color.Red});
  else 
    console.log(tag+flag);

}

webView.getUrl.implementation = function(){
    colorLog('[i] Current Loaded url:' + this.getUrl(),{c:Color.Blue});
    dumpWebview(this);
    return this.getUrl();
}

webView.loadData.implementation = function(data,mimeType, encoding){
    console.log('[i] Load data called with the following parameters:\\n' + 'Data:' + data + '\\nMime type: '+mimeType+'\\nEncoding: '+ encoding);
    this.loadData(data,mimeType,encoding);
}

webView.loadDataWithBaseURL.implementation = function(baseUrl,  data,  mimeType,  encoding,  historyUrl){
    agPacket({baseUrl: baseUrl, data: data, mimeType: mimeType, encoding: encoding, historyUrl: historyUrl}).send();
    this.loadDataWithBaseURL(baseUrl, data, mimeType, encoding, historyUrl);
}

webView.loadUrl.overload('java.lang.String', 'java.util.Map').implementation = function(url, additionalHttpHeaders) {
    agPacket({url: url}).send();
    dumpWebview(this);

    this.setWebContentsDebuggingEnabled(true);

    this.loadUrl(url,additionalHttpHeaders);
}


webView.loadUrl.overload('java.lang.String').implementation = function(url){
    agPacket({url: url}).send();

    dumpWebview(this);

    this.setWebContentsDebuggingEnabled(true);
    this.loadUrl(url);
}

webView.postUrl.implementation = function (url, postData){
    agPacket({url: url, postData: postData}).send();
    this.postUrl(url,postData);
}

webView.removeJavascriptInterface.implementation = function(name){
    agPacket({name: name}).send();
    this.removeJavascriptInterface(name);
}

webView.setWebViewClient.implementation = function(client){
    agPacket({className: client.$className}).send();
    this.setWebViewClient(client);
}